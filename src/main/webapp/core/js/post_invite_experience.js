$(function($) {	"use strict";	$LAB			.wait(					function() {//						var vali = {							vali_time : '.vali_time',							vali_time_pattern : /^([1-9][0-9]*)?$/,							init : function() {								var _this = this;								/** 时间校验 */								$(document).on('keyup blur', this.vali_time, function() {									if (!_this.vali_time_pattern.test($(this).val())) {										$(this).val('');									}								});								/** 非空校验 */							},							valiTime : function(val) {								return _this.vali_time_pattern.test($(this).val());							},							showDanger_default : {								placement : 'top',								destroy : false							// distime: 2000							},							showDanger : function($ele, opts) { // 以Bootstrap								// Tooltip形式展现错误								var _this = this;								opts = $.extend(_this.showDanger_default, opts);								var placement = _this.showDanger_default.placement || 'top';								$ele.addClass('vali_error');								$ele.tooltip('show');								$('div.tooltip:last').find('.tooltip-arrow').addClass(										'tooltip-arrow-danger-' + placement);								$('div.tooltip:last').find('.tooltip-inner').addClass('tooltip-inner-danger');								$ele.one('hidden.bs.tooltip', function() {									$ele.removeClass('vali_error');									if (opts.destroy) {										$ele.tooltip('destroy');									} else {										$('div.tooltip').find('.tooltip-arrow').removeClass(												'tooltip-arrow-danger-' + placement);										$('div.tooltip').find('.tooltip-inner').removeClass('tooltip-inner-danger');									}								});								if (opts.distime) {									setTimeout(function() {										$ele.tooltip('destroy');										$ele.removeClass('vali_error');									}, opts.distime);								}							},							locate : function(target) { // 页面滚动到指定class								window.location.hash = target;								var target_offset = $('.' + target).offset().top;								$('html, body').stop().animate({									scrollTop : target_offset - 40								}, 600);							}						};						vali.init();												var mailData;						var mail = {							$wrapper : $('div.mail'),							$mailModal : $('#modal_mail'),							companyInfo : {								code : 'SUCCESS',								companyName : ''							},							init : function() {								this.initModal();								this.loadMailInfo();							},							initModal : function() {								return;								var _this = this;								this.$companyModal.modal({									backdrop : 'static',									keyboard : false,									show : false								});								var $saveBtn = this.$companyModal.find('button.save-company');								var $input = this.$companyModal.find('#company_name');								$input.bind('keyup blur', function() {									var val = $.trim($(this).val());									if (val) {										$saveBtn.removeAttr('disabled');									} else {										$saveBtn.attr('disabled', 'disabled');									}								});								$saveBtn.click(function() {									var val = $.trim($input.val());									if (val) {										_this.saveCompanyName(val, $(this));									}								});							},							loadMailInfo : function() {								var _this = this;								var success = false;								$										.ajax({											url : root + '/sets/experience/getMailInfo/' + SETS_POSITION_ID,											type : 'post',											success : function(data) {												if (data.code == 0) {													if (data.data) {														success = true;														mailData = data.data;														_this.render(data.data);														//获取职位名称同步信息														_this.positionName(data.data);														_this.messageCommon(data.data);//														_this.datePicker();													}												}											},											error : function() {											},											complete : function() {												if (!success) {													_this															.render({																subject : '获取邮件主题失败',																content : '获取邮件内容失败,请<a onclick="javascript:window.location.reload();">刷新</a>重试'															})												} else {													addCandi.$inviteBtn.removeAttr('disabled');												}											}										});							},							render : function(data) {								/*this.$wrapper.find('div:first').text(data.subject);*/								this.$wrapper.find('div:last').html(data.content);								$('.title_position').val(data.testPositionName).focus().blur();								this.$wrapper.find('center>div').css('width', '100%');								// 屏蔽超链接..								$('#_url').css({"cursor":"default","text-decoration":"none","color":"#000"});								$('#_url').attr({"href":"javascript:void(0);"});								$('#_url').click(function()								{									return false;										});							},							//同步职位名称							positionName : function(data){								$('#emailTitle').on('keyup','.title_position',function(){									if($(this).val()==""){										$('#subject').text(data.subject);										$('.mail_content').find('#company_position').text(data.testPositionName);										$(this).addClass("vali_error wrong_shadow");										$('.submit').attr("disabled","disabled");									}else{										$(this).removeClass("vali_error wrong_shadow");										$('.mail_content').find('#company_position').text($(this).val());										$('.submit').removeAttr("disabled");									}								});																$('.invite_email').on("keyup","#datetimepicker5",function(){										if($(this).val()==""){											$(this).addClass("vali_error wrong_shadow");											$('.submit').attr("disabled","disabled");										}else{											$(this).removeClass("vali_error wrong_shadow");											$('.submit').removeAttr("disabled");										}								});																if(data.hasInterview==0){									$('#prompt').text("不勾选“必须有摄像头，才能进行考试”，意味着没有摄像头的应聘者，没有报告头像、不被监考。");								}								$('#camera').click(function(e){									if($(this).is(":checked")){										$('#prompt').stop().slideUp();										$('#try_').hide();									}else{										$('#prompt').stop().slideDown();										// 尽量确保您的电脑摄像头运行正常										$('#try_').show();									}								});							},							messageCommon:function(data){								var $titleArea = $('#emailTitle');								var $inviteTime = $('#datetimepicker5');								var $subject = $('#subject');								var subject = data.subject.split("-");								$subject.text(data.subject);								$inviteTime.val(data.validDate);							},							//datetimePicker日期插件 计算邀请失效时间							datePicker: function () {								var $datepicker = $('#datetimepicker5');								var $inviteTime = $('.invite_time');								var myDate = new Date();								var month = myDate.getMonth()+1;								var date = myDate.getDate();								if(month<10)									{									   month = '0'+month;									}								if(date<10)									{									  date = '0'+date;									}								var year = myDate.getFullYear();								var minDate = month+"/"+date+"/"+year;								var mo = moment().month()*1+2;								var maxDate = mo+"/"+date+"/"+year;				                $datepicker.datepicker({				                	 pickTime:false,				                	 format:'yyyy-mm-dd',				                	 startDate:new Date(year,month-1,date),				                	 endDate:new Date(year,month,date),				                	 language:'zh-CN',									 autoclose: true				                });				                //接收到后台给出的初始化邀请时间				                var initInviteTime = $datepicker.val();				                //初始化计算邀请失效时间				                var testDate0 = initInviteTime.split("-");				                testDate0 = new Date(testDate0[0],testDate0[1],testDate0[2]);				                var testDate = new Date(year,month,date);				                var initAiDate = (testDate0.getTime()-testDate.getTime())/(1000*3600*24);				                var hours = moment().hours();				                $inviteTime.text(initAiDate*1+1+"天");				                $datepicker.change(function(){				                	$('#datetimepicker5').removeClass("vali_error wrong_shadow");									$('.submit').removeAttr("disabled");				                		$datepicker.blur();						                var time = $datepicker.val();						                if(time!=""){						                	var a = moment(time,'YYYYMMDD').fromNow();						                	var today = year+"/"+month+"/"+date;						                	today = today.replace(/\//g,'')*1;						                	var visibleDate = time.split("-");						                	visibleDate = visibleDate[0]+"年"+visibleDate[1]+"月"+visibleDate[2]+"日";						                	var date = time.split("-");						                	date = new Date(date[0],date[1],date[2]);						                	var inviteTime = (date.getTime()-testDate.getTime())/(1000*3600*24);						                	$inviteTime.text(inviteTime*1+1+"天");						                							                	$('.mail_content').find('#visibleDate').text(visibleDate);						                }						                });							},													};						mail.init();						var addCandi = {							$wrapper : $('.add-candi'),							$candNameInput : $('.add-candi input#candi_name'),							$candEmailInput : $('.add-candi input#candi_email'),							$inviteBtn : $('.add-candi>button.submit'),							$alert : $('.add-candi div.alert-warning'),							$hrModal: $('#modal_hr'),							alertDefaultTxt : '添加一个应聘人',							candi: {},							init : function() {																this.initHrModal();																var _this = this;								_this.$inviteBtn.click(function(){									_this.invite();								});								this.$candNameInput.keydown(function(e) {									if (e.keyCode == 13) {										_this.invite();										return false;									}								});								this.$candEmailInput.keydown(function(e) {									if (e.keyCode == 13) {										_this.invite();										return false;									}								});							},							initHrModal: function(){								this.$modalHrMsg =  this.$hrModal.find('.alert');								this.$inputHrEmail = this.$hrModal.find('#company_email');								this.$saveEmailBtn = this.$hrModal.find('.save-company-email');																var _this = this;																this.$hrModal.on('shown.bs.modal', function(){									_this.$inputHrEmail.val(_this.candi.email);								});																this.$hrModal.on('hidden.bs.modal', function(){									_this.$modalHrMsg.html('').hide();									_this.$inputHrEmail.val('');								});																this.$inputHrEmail.keydown(function(e) {									if (e.keyCode == 13) {										_this.$saveEmailBtn.trigger('click');										return false;									}								});																this.$saveEmailBtn.click(function(){																		_this.$modalHrMsg.html('').hide();									var email = $.trim(_this.$inputHrEmail.val());									if(!email){										_this.$inputHrEmail.tooltip({											container : 'body',											title : '请输入您的公司邮箱'										});										vali.showDanger(_this.$inputHrEmail, {											distime : 2000,											destroy : true										});										return false;									} else if (!/^[\w\-][\w\-\.]*@[a-z0-9]+([a-z0-9\-\.]*[a-z0-9\-]+)*\.[a-z0-9]{2,}$/ig											.test(email)) {										_this.$inputHrEmail.tooltip({											container : 'body',											title : 'Email格式不对哦'										});										vali.showDanger(_this.$inputHrEmail, {											distime : 2000,											destroy : true										});										return;									}																		var domainValid = true									$.ajax({										url : root + '/sets/invitation/checkEmailDomain?email=' + email,										type : 'post',										async : false, //同步校验										contentType : 'application/json',										beforeSend: function(){											_this.$saveEmailBtn.attr('disabled', 'disabled').text('正在校验邮箱...');										},										success : function(data) {											if (data.code == 0 && data.data) {												if (data.data.code == 'SUCCESS') {													if(data.data.message=='0') // 校验不通过													{														domainValid = false;														_this.$inputHrEmail.tooltip({															container : 'body',															title : 'Email地址不对哦'														});														vali.showDanger(_this.$inputHrEmail, {															distime : 2000,															destroy : true														});													}												}											}										},										complete: function(){											_this.$saveEmailBtn.removeAttr('disabled').text('确认');										}									});									if(!domainValid){										return;									}																		var emailValid = false;									var errorInfo;									$.ajax({										type: 'post',										url : root + '/sets/experience/checkMail',										contentType : 'application/json',										data : JSON.stringify({											employerEmail : email										}),										beforeSend: function(){											_this.$saveEmailBtn.attr('disabled', 'disabled').text('正在校验邮箱...');										},										success: function(data){											if (data.code == 0 && data.data) {												if (data.data.code == 'SUCCESS') {													emailValid = true;												} else {													switch (data.data.code) {													case 'EMAILNOTSUPPORT':														errorInfo = '请输入公司内部邮箱，QQ、网易、新浪等公共邮箱目前不能开通测评服务';														break;													case 'ACCTREGISTERED':														errorInfo = '当前邮箱已注册';														break;													}												}											}										},										complete: function(){											_this.$saveEmailBtn.removeAttr('disabled').text('确认');											if(emailValid){												_this.sendEmail(email);												_this.$hrModal.modal('hide');											}else{												_this.$modalHrMsg.html(errorInfo).show();											}										}									});								});							},							invite: function(){								this.candi.name = $.trim(this.$candNameInput.val());								this.candi.email = $.trim(this.$candEmailInput.val());								if (!this.validate(this.candi)) {									this.$hrModal.modal();								}															},							validate : function(candi) {								var hasError = false;								if (candi.name == '') {									hasError = true;									this.$candNameInput.tooltip({										container : 'body',										title : '请输入姓名'									});									vali.showDanger(this.$candNameInput, {										distime : 2000,										destroy : true									});									return hasError;								};								if (candi.email == '') {									hasError = true;									this.$candEmailInput.tooltip({										container : 'body',										title : '请输入Email'									});									vali.showDanger(this.$candEmailInput, {										distime : 2000,										destroy : true									});									return hasError;								} else if (!/^[\w\-][\w\-\.]*@[a-z0-9]+([a-z0-9\-\.]*[a-z0-9\-]+)*\.[a-z0-9]{2,}$/ig										.test(candi.email)) {									hasError = true;									this.$candEmailInput.tooltip({										container : 'body',										title : 'Email格式不对哦'									});									vali.showDanger(this.$candEmailInput, {										distime : 2000,										destroy : true									});									return hasError;								}																var _this = this;								// 校验邮箱域名是否合法；同步请求								$.setsAjax({									url : root + '/sets/invitation/checkEmailDomain?email=' + candi.email,									type : 'post',									async : false, //同步校验									contentType : 'application/json',									beforeSend: function(){										_this.$inviteBtn.fadeOut();									},									success : function(data) {										if (data.code == 0 && data.data) {											if (data.data.code == 'SUCCESS') {												if(data.data.message=='0') // 校验不通过												{													hasError = true;													_this.$candEmailInput.tooltip({														container : 'body',														title : 'Email地址不对哦'													});													vali.showDanger(_this.$candEmailInput, {														distime : 2000,														destroy : true													});												}											}										}									},									complete: function(){										_this.$inviteBtn.fadeIn();									}								});																return hasError;															},							sendEmail: function(employerEmail){								var _this = this;								var needCamera = 0;								if($('#camera').is(":checked")){								   needCamera = 1;								}																var reqData = {									employerEmail :employerEmail,									positionId : SETS_POSITION_ID,									candidateName : this.candi.name,									candidateEmail : this.candi.email,//									validDate :　$('#datetimepicker5').val(),									validDate :　mailData.validDate,//									testPositionName : $('.title_position').val(),									testPositionName : mailData.testPositionName,									canWithOutCamera : 1,									selfContext: '此次测评成绩十分重要，请认真作答。'								};								var success = false;								var errorMsg;								var preContent = this.$inviteBtn.html();								$.setsAjax({									url : root + '/sets/experience/invite/',									type : 'post',									contentType : 'application/json',									data : JSON.stringify(reqData),									beforeSend : function() {										_this.$inviteBtn.attr('disabled', 'disabled').text('正在发送邀请...');									},									success : function(data) {										if (data.code == 0 && data.data) {											if (data.data.code == 'SUCCESS') {												success = true;											} else if(data.data.code == 'SAMPLEMAXNUM'){												errorMsg = 'experienced already';												$('#commit_result').modal({													keyboard: false,													backdrop: 'static',													show: true												});											}										}									},									complete : function() {										if(success){											_this.$inviteBtn.hide();											_this.inviteDone(employerEmail);										}else if(errorMsg){											_this.$inviteBtn.hide();//											_this.$alert.html(errorMsg).show();										}else{											_this.$inviteBtn.removeAttr('disabled').text('邀请失败，请重试');										}									}								});							},							inviteDone: function(employerEmail){								var _this = this;								var qrCode = [];								$('input').attr('disabled', 'disabled');								var items = [];								items.push('恭喜您，邀请成功！赶紧收邮件，体验百一测评的快感吧！');								items.push(qrCode.join(''));								_this.$alert.html(items.join('')).show();							}						};						addCandi.init();												//创建邀请邮件模板头部						var createMailView = {							init:function(){							var _this = this;							this.createTitle();							},							createTitle:function(){								var $titleArea = $('#emailTitle');								var titleContent = [];								//								titleContent.push('<dt class="email_title">招聘职位名称</dt>');//								titleContent.push('<dd><input class="form-control content_input title_position" type="text" placeholder="应聘人看到的职位名称，例：大数据开发工程师"></dd>');//								titleContent.push('<dt class="email_title">答题有效期至</dt>');//								titleContent.push('<dd><ul class="invite_email">');//								titleContent.push('<li><input type="text" class="form-control" id="datetimepicker5" readOnly style="background:#fff;cursor:default;"/></li>')//								titleContent.push('<li style="margin-top:20px">邀请 <span class="invite_time"></span>以后失效<span class="wrong_lang">所选时间错误,请重新选择</span></li>');//								titleContent.push('</ul></dd>');//								titleContent.push('<dt class="email_title"></dt>');//								titleContent.push('<dd style="margin-top:10px"><label style="font-weight:normal;"><input id="camera" type="checkbox" style="margin-left:20px" checked="checked"><span style="padding-left:15px">必须有摄像头，才能进行考试。 </span><label><br></dd>');//								titleContent.push('<dt class="email_title"></dt><dd><div id="prompt" class="alert alert-warning none mt10" style="margin-left:20px;margin-bottom:0px">这份测评包含面试题。不勾选“必须有摄像头，才能进行考试”，意味着没有摄像头的应聘者，没有报告头像、不被监考、不用回答面试题。</div></dd>');								titleContent.push('<dt class="email_title">邮件主题</dt>');								titleContent.push('<dd><label class="form-control content_input subject title_position" id="subject"></label></dd>');								$titleArea.html(titleContent.join(''));															},														}                        createMailView.init();											});});